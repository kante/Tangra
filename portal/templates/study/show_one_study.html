{% extends 'base.html' %}
{% load helpers %}
{% block content %}

<link href="{{ MEDIA_URL }}css/video_conferencing.css" type="text/css" rel="stylesheet" >
<script src="{{ MEDIA_URL }}js/video_conferencing/ajax_requests.js" type="text/javascript" charset="utf-8"></script>

<div class="hidden_data" id="ajax_response">HIDDEN!</div>



<h1>{{ study.name }}</h1>

{% ifequal as_inv 0 %}
<div id="supertabs">
<ul>

{% if not video_request %}
	<li class="tablink on" id="tab1">Study Progress</li>
{% else %}
	<li class="tablink" id="tab1">Study Progress</li>
{% endif %}

<li class="tablink" id="tab2">About Study</li>


{% if video_request %}
	<li class="tablink on" id="tab3">VIDEO REQUEST</li>
{% endif %}

</ul>
</div>

<!--stage menu-->
{% if video_request %}
	<div id="tab1box" class="tab" style="display:none">
{% else %}
	<div id="tab1box" class="tab" >
{% endif %}

	  <div id="stages_nav" class="clearfix" num="{{stages.count}}">
	    <ul>
	    {% for astage in stages %} 
			  {% if astage.status > 1  %}
	        <li class="stage not_active future"><a href="" id="stage_box_{{forloop.counter}}" onclick="return false;" class="stage_box">{{astage.stage.display}}</a></li>
			  {% else %}
				  {% ifequal astage.status 1 %}
				    <li class="stage active present"><a href="" id="stage_box_{{forloop.counter}}" class="stage_box">{{astage.stage.display}}</a></li>
				  {% else %}
				    <li class="stage not_active past"><a href="" id="stage_box_{{forloop.counter}}" class="stage_box">{{astage.stage.display}}</a></li>
				  {% endifequal %}
			  {% endif %}
		{% endfor%}

	  </ul>
	  </div>
		<!--stage block-->

	  <div id="stage_info">
		{% for astage in stages %}  

	    <div id="stage_{{forloop.counter}}" class="stage_panel"
	      {% ifnotequal astage.status 1 %}style="display:none;"{% endifnotequal %}>
	      <div class="stage_header">
			<table><tr><td>
	       <h2 class="first">Description</h2>

	        {{astage.stage.instructions|safe}}

			<h2>Status</h2>
	        <h2 class="stage_status">
	        	{%ifequal astage.status 1 %}
					{%if astage.overdue%}
					    <span class="red">Session due: {{astage.nextdeadline|date:"d M Y"}}</span>
				    {% else %}
					    Session due: {{astage.nextdeadline|date:"d M Y"}}
				    {% endif %}
					
				{% else %}{%ifequal astage.status 2 %}
					Future stage: no action required.
				{% else %}
					<span class="green">Stage complete!</span>
				{% endifequal %}
				{% endifequal %}

	        </h2>
	      </td><td width="20%">
	      <span style="display: block"><p style="font-weight: bold;">Sessions Completed:</p>
		<h2> {{astage.sessions_completed}} (of {{astage.stage.sessions}})</h2></span>
		<div style="height:80px;">
		{%ifequal astage.status 1 %}
			{%if astage.overdue %}
				<a href="{{action}}" class="actbutton red">Start Session</a>
			{%else %}
				<a href="{{action}}" class="actbutton green">Start Session</a>
			{% endif %}
		{% endifequal%}</div>
		</td></tr></table>
	    </div></div>
	  {% endfor %}
	  </div>
	
</div>


<div id="tab2box" class="tab" style="display:none">
	<div id="study_details">
		<h2><a href="" onclick="return toggle_detail('d1',$(this));" class="right">Description</a></h2>
	  	<div id="d1" style="display:none;">{{study.description|safe}}</div>
		<h2><a href=""  onclick="return toggle_detail('d2',$(this));false;"  class="right">Informed Consent</a></h2>
		<div id="d2"  style="display:none;">{{study.consent|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d3',$(this));"  class="right">Instructions</a></h2>
		<div id="d3"  style="display:none;">{{study.instructions|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d4',$(this));"  class="right">Eligibility</a></h2>
		<div id="d4" style="display:none;">{{study.eligibility|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d5',$(this));"  class="right">Reward</a></h2>
		<div id="d5" style="display:none;">{{study.reward|safe}}</div>
	</div>
</div>


{% if video_request %}
	<div id="tab3box" class="tab">
		<div style="width:100%; text-align:center;">
			Hello there! You have been selected for a video chat with one of our
			study investigators. Would you like to accept this request? <br>
			<div style="width:250px;background-color:green;color:black;">
				<a href="#" onclick="javascript:connect();">
					YES
				</a>
			</div>

			<div style="width:250px;background-color:red;color:black;">
				<a href="#" onclick="javascript:decline_video_request('{{ username }}');">
					NO
				</a>
			</div>
						
			
			<link href="{{ MEDIA_URL }}css/video_conferencing.css" type="text/css" rel="stylesheet" >
			<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript" charset="utf-8"></script>
			<script>
				// These are the variables that need to be set in Django using the TokBox 
				// server-side API. 

				// It is important that they are set BEFORE you include the video_div.js 
				// script below.

				var apiKey = 1127; // OpenTok sample API key. Replace with your own API key.
				var sessionId = '153975e9d3ecce1d11baddd2c9d8d3c9d147df18'; // Replace with your session ID.
				var token = 'devtoken'; // Should not be hard-coded. Add via python SSL.
			</script>
			<script src="{{ MEDIA_URL }}js/video_conferencing/open_tok.js" type="text/javascript" charset="utf-8"></script>


			<div id="opentok_console"></div>
			<div id="links">
			      	<input type="button" value="Connect" id ="connectLink" onClick="javascript:connect()" />
			      	<input type="button" value="Leave" id ="disconnectLink" onClick="javascript:disconnect()" />
			      	<input type="button" value="Start Publishing" id ="publishLink" onClick="javascript:startPublishing()" />
			      	<input type="button" value="Stop Publishing" id ="unpublishLink" onClick="javascript:stopPublishing()" />
			</div>
			<div id="myCamera" class="publisherContainer"></div>
			<div id="subscribers"></div>

			<script>
				show('connectLink');
			</script>

		</div>

	</div>
{% endif %}


{% else %}
{% ifequal as_inv 1%}

<!-- Investigator -->

<div>
  <a href="/study/datadump/{{study.id}}" class="actbutton grey">Export Data</a>
</div>
<br/><br/>
<div><img src="{% media_url %}img/mockup.png" width=1000></img></div>
<!-->
<div id="inv_stages_nav">
<ul>
    {% for cond in conditions %}
	<li>
 		Condition: {{cond.group.name}}
		
		<ul>{% for astage in cond.stages %}
		  {% if astage.status > 1  %}
        	<li class="not_active"><a href="" cond="{{cond.group.id}}" id="box_stage_{{cond.group.id}}_{{forloop.counter}}" onclick="return false;" class="stage_box present">{{astage}} - {{astage.number_of_users}}</a></li>
		  {% else %}
			    <li class="not_active"><a href="" cond="{{cond.group.id}}" id="box_stage_{{cond.group.id}}_{{forloop.counter}}" class="stage_box present">{{astage}} - {{astage.number_of_users}}</a></li>
		  {% endif %}

		{% endfor%}
		</ul>
	</li>	

	{% endfor%}
</ul>
{% for cond in conditions %}
{% for stage in cond.stages %}
	    <div id="stage_{{cond.group.id}}_{{forloop.counter}}" class="stage_panel" style="display:none;">
	      <div class="stage_header">
	        <h2><strong>Stage: </strong> {{stage.name}} ({{stage.number_of_users}})</h2>
	        </div>
	    </div>
		  {% endfor %}{% endfor %}
		
</div>

{% endifequal %}
{% endifequal %}
<!-->

{% endblock %}
