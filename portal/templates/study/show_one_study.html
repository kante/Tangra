{% extends 'base.html' %}
{% load helpers %}
{% block content %}

<!-- javascript includes -->
<script src="{{ MEDIA_URL }}js/video_conferencing/ajax_requests.js" type="text/javascript" charset="utf-8"></script>

<!-- CSS includes -->>
<link href="{{ MEDIA_URL }}css/video_conferencing.css" type="text/css" rel="stylesheet" >
<link href="{{ MEDIA_URL }}css/investigator/user_table.css" type="text/css" rel="stylesheet" >
<link href="{{ MEDIA_URL }}css/participant/study.css" type="text/css" rel="stylesheet" >



<div class="hidden_data" id="ajax_response">HIDDEN!</div>

<h1>{{ study.name }}</h1>

<div id="supertabs">
<ul>

{% if not video_request %}
	<li class="tablink on" id="tab1">Study Progress</li>
{% else %}
	<li class="tablink" id="tab1">Study Progress</li>
{% endif %}

<li class="tablink" id="tab2">About Study</li>


{% if video_request %}
	<li class="tablink on" id="tab3">VIDEO REQUEST</li>
{% endif %}

</ul>
</div>

<!-- tab1box is active if there is no video request -->
{% if video_request %}
	<div id="tab1box" class="tab" style="display:none">
{% else %}
	<div id="tab1box" class="tab" >
{% endif %}


<!-- stage_navigator
		display subject stage and allow for selection of future or past stages
		with CLEAR messages telling the user what's going on.
		TODO: make the messages clear lol
-->
<div id="stages_nav" class="clearfix" num="{{ stages.count }}">
	<ul>
		{% for astage in stages %} 
			{% if astage.status > 1	 %}
				<li class="stage not_active future">
					<a href="" id="stage_box_{{forloop.counter}}" onclick="return false;" class="stage_box">
						{{ astage.stage.display }}
					</a>
				</li>
			{% else %}
				  {% ifequal astage.status 1 %}
					<li class="stage active present">
						<a href="" id="stage_box_{{forloop.counter}}" class="stage_box">
							{{ astage.stage.display }}
						</a>
					</li>
				  {% else %}
					<li class="stage not_active past">
						<a href="" id="stage_box_{{forloop.counter}}" class="stage_box">
							{{ astage.stage.display }}
						</a>
					</li>
				  {% endifequal %}
			{% endif %}
		{% endfor%}
	</ul>
</div>


<!-- 
	stage_info_display. one subdiv active at a time, controlled by stage 
	navigator above
 -->
<div id="stage_info">
		{% for astage in stages %}  

	    <div id="stage_{{forloop.counter}}" class="stage_panel"
	      {% ifnotequal astage.status 1 %}style="display:none;"{% endifnotequal %}>
	      <div class="stage_header">
			<table><tr><td>
	       <h2 class="first">Description</h2>

	        {{astage.stage.instructions|safe}}

			<h2>Status</h2>
	        <h2 class="stage_status">
	        	{%ifequal astage.status 1 %}
					{%if astage.overdue%}
					    <span class="red">Session due: {{astage.nextdeadline|date:"d M Y"}}</span>
				    {% else %}
					    Session due: {{astage.nextdeadline|date:"d M Y"}}
				    {% endif %}
					
				{% else %}{%ifequal astage.status 2 %}
					Future stage: no action required.
				{% else %}
					<span class="green">Stage complete!</span>
				{% endifequal %}
				{% endifequal %}

	        </h2>
	      </td><td width="20%">
	      <span style="display: block"><p style="font-weight: bold;">Sessions Completed:</p>
		<h2> {{astage.sessions_completed}} (of {{astage.stage.sessions}})</h2></span>
		<div style="height:80px;">
		{%ifequal astage.status 1 %}
			{%if astage.overdue %}
				<a href="{{action}}" class="actbutton red">Start Session</a>
			{%else %}
				<a href="{{action}}" class="actbutton green">Start Session</a>
			{% endif %}
		{% endifequal%}</div>
		</td></tr></table>
	    </div></div>
	  {% endfor %}
	  </div>
	
</div>


<div id="tab2box" class="tab" style="display:none">
	<div id="study_details">
		<h2><a href="" onclick="return toggle_detail('d1',$(this));" class="right">Description</a></h2>
	  	<div id="d1" style="display:none;">{{study.description|safe}}</div>
		<h2><a href=""  onclick="return toggle_detail('d2',$(this));false;"  class="right">Informed Consent</a></h2>
		<div id="d2"  style="display:none;">{{study.consent|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d3',$(this));"  class="right">Instructions</a></h2>
		<div id="d3"  style="display:none;">{{study.instructions|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d4',$(this));"  class="right">Eligibility</a></h2>
		<div id="d4" style="display:none;">{{study.eligibility|safe}}</div>
		<h2><a href="" onclick="return toggle_detail('d5',$(this));"  class="right">Reward</a></h2>
		<div id="d5" style="display:none;">{{study.reward|safe}}</div>
	</div>
</div>


{% if video_request %}
	<link href="{{ MEDIA_URL }}css/video_conferencing.css" type="text/css" rel="stylesheet" >
	
	<div id="tab3box" class="tab">
		<div style="width:100%; text-align:center;">
			<br>
				Hello there! One of our investigators would appreciate the 
				opportunity to speak to about your study. Would you like to 
				accept this request for a video chat? 
			<br>
			<div style="display:inline;width:250px;background-color:green;color:black;">
				<a style="width:200px" href="#" onclick="javascript:connect();">
					YES
				</a>
			</div>
			
			<div style="display:inline;width:250px;background-color:red;color:black;">
				<a href="#" onclick="javascript:decline_video_request('{{ username }}');">
					NO
				</a>
			</div>
			<br><br><br><br><br>
			<script src="http://staging.tokbox.com/v0.91/js/TB.min.js" type="text/javascript" charset="utf-8"></script>
			<script>
				// These are the variables that need to be set in Django using the TokBox 
				// server-side API. 

				// It is important that they are set BEFORE you include the video_div.js 
				// script below.

				var apiKey = 1127; // OpenTok sample API key. Replace with your own API key.
				var sessionId = '153975e9d3ecce1d11baddd2c9d8d3c9d147df18'; // Replace with your session ID.
				var token = 'devtoken'; // Should not be hard-coded. Add via python SSL.
			</script>
			<script src="{{ MEDIA_URL }}js/video_conferencing/open_tok.js" type="text/javascript" charset="utf-8"></script>


		
			<div id="opentok_console"></div>
			
			

			<div id="admin_video_wrapper">
				<table style="width:90%">
					<tr>
						<th> Participant Video </th>
						<th> Investigator Video </th>
					</tr>

					

					<tr>
						<td>
							<div id="myCamera" class="publisherContainer"></div>
						</td>
						<td>
							<div id="subscribers"></div>
						</td>
					</tr>

					<tr>
						<td>
							<div id="links">
								<input type="button" value="Connect" id ="connectLink" onClick="javascript:connect()" />
								<input type="button" value="Leave" id ="disconnectLink" onClick="javascript:disconnect()" />
								<input type="button" value="Start Publishing" id ="publishLink" onClick="javascript:startPublishing()" />
								<input type="button" value="Stop Publishing" id ="unpublishLink" onClick="javascript:stopPublishing()" />
							</div>
						</td>
						<td>
							
						</td>
					</tr>

				</table>
			</div>
			<script>
				show('connectLink');
			</script>

		</div>

	</div>
	
{% endif %} <!-- endif video_request-->


{% endblock %}
